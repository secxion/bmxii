from flask import Flask, request, jsonify, render_template_string
from flask_sqlalchemy import SQLAlchemy
from flask_cors import CORS
from datetime import datetime
import os
from email.mime.text import MIMEText
from email.mime.multipart import MIMEMultipart
import smtplib
import logging
from urllib.parse import quote_plus # Added for URL encoding password
from sqlalchemy import inspect # Moved to top level

# Initialize Flask app
app = Flask(__name__)
app.config['SECRET_KEY'] = 'your-secret-key-here' # Remember to change this to a strong, unique key!

# Database configuration for MySQL
# IMPORTANT: Replace 'your_secure_password' with the actual password you set for 'bmxii_user'
# The '@' in your password 'Bmxii.DataBase@0219' needs to be URL-encoded as %40
# So, 'Bmxii.DataBase@0219' becomes 'Bmxii.DataBase%400219'
db_password_encoded = quote_plus("Bmxii.DataBase@0219") # Use quote_plus to safely encode password
app.config['SQLALCHEMY_DATABASE_URI'] = f'mysql+pymysql://bmxii_user:{db_password_encoded}@localhost/bmxii_db'
app.config['SQLALCHEMY_TRACK_MODIFICATIONS'] = False
app.config['SQLALCHEMY_ENGINE_OPTIONS'] = {
    'pool_timeout': 20,
    'pool_recycle': 3600, # Recommended for MySQL to avoid "MySQL has gone away"
    'pool_pre_ping': True
}

# Initialize extensions
db = SQLAlchemy(app)
CORS(app)

# Configure logging
logging.basicConfig(level=logging.INFO)
logger = logging.getLogger(__name__)

# Database Models
class ContactMessage(db.Model):
    __tablename__ = 'contact_messages'

    id = db.Column(db.Integer, primary_key=True)
    name = db.Column(db.String(100), nullable=False)
    email = db.Column(db.String(120), nullable=False)
    phone = db.Column(db.String(20), nullable=True)
    service = db.Column(db.String(100), nullable=True)
    message = db.Column(db.Text, nullable=False)
    timestamp = db.Column(db.DateTime, default=datetime.utcnow, nullable=False)
    is_read = db.Column(db.Boolean, default=False, nullable=False)

    def to_dict(self):
        return {
            'id': self.id,
            'name': self.name,
            'email': self.email,
            'phone': self.phone,
            'service': self.service,
            'message': self.message,
            'timestamp': self.timestamp.isoformat(),
            'is_read': self.is_read
        }

def init_database():
    """Initialize database tables using SQLAlchemy for MySQL"""
    with app.app_context():
        try:
            db.create_all()
            logger.info("Database tables created successfully or already exist.")
        except Exception as e:
            logger.error(f"Error creating database tables: {e}")
            raise # Re-raise to ensure app doesn't start if tables can't be created

# Email configuration (optional - configure with your SMTP settings)
EMAIL_CONFIG = {
    'SMTP_SERVER': 'smtp.gmail.com',  # Change to your SMTP server
    'SMTP_PORT': 587,
    'EMAIL_ADDRESS': 'your-email@gmail.com',  # Your email
    'EMAIL_PASSWORD': 'your-app-password',  # App password for Gmail
    'ADMIN_EMAIL': 'admin@bmxii.org'  # Admin email to receive notifications
}

def send_email_notification(contact_data):
    """Send email notification to admin when new contact message is received"""
    try:
        msg = MIMEMultipart()
        msg['From'] = EMAIL_CONFIG['EMAIL_ADDRESS']
        msg['To'] = EMAIL_CONFIG['ADMIN_EMAIL']
        msg['Subject'] = f"New Contact Message from {contact_data['name']} - BMXII"

        body = f"""
        New contact message received from BMXII website:

        Name: {contact_data['name']}
        Email: {contact_data['email']}
        Phone: {contact_data.get('phone', 'Not provided')}
        Service Interest: {contact_data.get('service', 'Not specified')}

        Message:
        {contact_data['message']}

        Timestamp: {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}
        """

        msg.attach(MIMEText(body, 'plain'))

        server = smtplib.SMTP(EMAIL_CONFIG['SMTP_SERVER'], EMAIL_CONFIG['SMTP_PORT'])
        server.starttls()
        server.login(EMAIL_CONFIG['EMAIL_ADDRESS'], EMAIL_CONFIG['EMAIL_PASSWORD'])
        text = msg.as_string()
        server.sendmail(EMAIL_CONFIG['EMAIL_ADDRESS'], EMAIL_CONFIG['ADMIN_EMAIL'], text)
        server.quit()

        logger.info("Email notification sent successfully")
        return True
    except Exception as e:
        logger.error(f"Failed to send email notification: {str(e)}")
        return False

# Routes
@app.route('/')
def index():
    """Serve the main portfolio page"""
    try:
        with open('index.html', 'r', encoding='utf-8') as f:
            return render_template_string(f.read())
    except FileNotFoundError:
        return jsonify({'error': 'index.html not found'}), 404

@app.route('/api/contact', methods=['POST'])
def contact():
    """Handle contact form submissions"""
    try:
        data = request.get_json()

        # Validate required fields
        if not data or not data.get('name') or not data.get('email') or not data.get('message'):
            return jsonify({
                'error': 'Missing required fields: name, email, and message are required'
            }), 400

        # Create new contact message
        contact_message = ContactMessage(
            name=data['name'].strip(),
            email=data['email'].strip().lower(),
            phone=data.get('phone', '').strip() if data.get('phone') else None,
            service=data.get('service', '').strip() if data.get('service') else None,
            message=data['message'].strip()
        )

        # Save to database with error handling
        try:
            db.session.add(contact_message)
            db.session.commit()
        except Exception as db_error:
            db.session.rollback()
            logger.error(f"Database error: {db_error}")
            return jsonify({'error': 'Database error occurred'}), 500

        # Send email notification (optional)
        send_email_notification(data)

        logger.info(f"New contact message received from {data['name']} ({data['email']})")

        return jsonify({
            'message': 'Contact message received successfully',
            'id': contact_message.id
        }), 201

    except Exception as e:
        logger.error(f"Error processing contact form: {str(e)}")
        return jsonify({
            'error': 'An error occurred while processing your message'
        }), 500

@app.route('/api/messages', methods=['GET'])
def get_messages():
    """Get all contact messages (admin endpoint)"""
    try:
        page = request.args.get('page', 1, type=int)
        per_page = request.args.get('per_page', 10, type=int)
        unread_only = request.args.get('unread_only', False, type=bool)

        query = ContactMessage.query

        if unread_only:
            query = query.filter_by(is_read=False)

        messages = query.order_by(ContactMessage.timestamp.desc()).paginate(
            page=page, per_page=per_page, error_out=False
        )

        return jsonify({
            'messages': [msg.to_dict() for msg in messages.items],
            'total': messages.total,
            'pages': messages.pages,
            'current_page': page
        })

    except Exception as e:
        logger.error(f"Error fetching messages: {str(e)}")
        return jsonify({'error': 'Failed to fetch messages'}), 500

@app.route('/api/messages/<int:message_id>', methods=['GET'])
def get_message(message_id):
    """Get a specific message by ID"""
    try:
        message = ContactMessage.query.get_or_404(message_id)

        # Mark as read when accessed
        if not message.is_read:
            message.is_read = True
            db.session.commit()

        return jsonify(message.to_dict())

    except Exception as e:
        logger.error(f"Error fetching message {message_id}: {str(e)}")
        return jsonify({'error': 'Message not found'}), 404

@app.route('/api/messages/<int:message_id>/read', methods=['PUT'])
def mark_message_read(message_id):
    """Mark a message as read/unread"""
    try:
        message = ContactMessage.query.get_or_404(message_id)
        data = request.get_json()

        message.is_read = data.get('is_read', True)
        db.session.commit()

        return jsonify({
            'message': 'Message status updated',
            'is_read': message.is_read
        })

    except Exception as e:
        logger.error(f"Error updating message {message_id}: {str(e)}")
        return jsonify({'error': 'Failed to update message'}), 500

@app.route('/api/messages/<int:message_id>', methods=['DELETE'])
def delete_message(message_id):
    """Delete a message"""
    try:
        message = ContactMessage.query.get_or_404(message_id)
        db.session.delete(message)
        db.session.commit()

        return jsonify({'message': 'Message deleted successfully'})

    except Exception as e:
        logger.error(f"Error deleting message {message_id}: {str(e)}")
        return jsonify({'error': 'Failed to delete message'}), 500

@app.route('/api/db-check', methods=['GET'])
def check_database():
    """Check database health and structure for MySQL"""
    try:
        with app.app_context():
            # Attempt a simple query to check connectivity
            db.session.execute(db.text("SELECT 1"))

            # Get table info using SQLAlchemy's inspector
            inspector = inspect(db.engine)
            tables = inspector.get_table_names()

            table_info = {}
            record_count = 0

            if 'contact_messages' in tables:
                # Get column info
                columns = inspector.get_columns('contact_messages')
                table_info['contact_messages_structure'] = [{'name': col['name'], 'type': str(col['type'])} for col in columns]

                # Count records
                record_count = db.session.query(ContactMessage).count()
            else:
                logger.warning("Table 'contact_messages' not found in MySQL database.")

        return jsonify({
            'status': 'success',
            'database_type': 'MySQL',
            'tables': tables,
            'contact_messages_structure': table_info.get('contact_messages_structure'),
            'record_count': record_count
        })

    except Exception as e:
        logger.error(f"Database check failed: {str(e)}")
        return jsonify({
            'status': 'error',
            'message': f"Database connection or query failed: {str(e)}"
        }), 500


@app.route('/admin')
def admin_dashboard():
    """Simple admin dashboard to view messages"""
    admin_html = """
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BMXII Admin Dashboard</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            color: #ffffff;
            min-height: 100vh;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 2rem;
        }

        .header {
            text-align: center;
            margin-bottom: 3rem;
        }

        .header h1 {
            font-size: 2.5rem;
            background: linear-gradient(135deg, #ffffff 0%, #a855f7 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 0.5rem;
        }

        .db-status {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            padding: 1rem;
            margin-bottom: 2rem;
        }

        .db-status.healthy {
            border-color: #22c55e;
            background: rgba(34, 197, 94, 0.1);
        }

        .db-status.error {
            border-color: #ef4444;
            background: rgba(239, 68, 68, 0.1);
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .stat-card {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 1.5rem;
            text-align: center;
        }

        .stat-number {
            font-size: 2rem;
            font-weight: bold;
            color: #a855f7;
            margin-bottom: 0.5rem;
        }

        .messages-container {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 2rem;
        }

        .message-card {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            padding: 1.5rem;
            margin-bottom: 1rem;
            position: relative;
        }

        .message-card.unread {
            border-color: #a855f7;
            box-shadow: 0 0 15px rgba(168, 85, 247, 0.2);
        }

        .message-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .message-info h3 {
            color: #ffffff;
            margin-bottom: 0.25rem;
        }

        .message-info p {
            color: #94a3b8;
            font-size: 0.9rem;
        }

        .message-badges {
            display: flex;
            gap: 0.5rem;
        }

        .badge {
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 500;
        }

        .badge.unread {
            background: #a855f7;
            color: white;
        }

        .badge.service {
            background: rgba(34, 197, 94, 0.2);
            color: #22c55e;
            border: 1px solid rgba(34, 197, 94, 0.3);
        }

        .message-content {
            color: #e2e8f0;
            line-height: 1.6;
            margin-bottom: 1rem;
        }

        .message-actions {
            display: flex;
            gap: 1rem;
        }

        .btn {
            padding: 0.5rem 1rem;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.3s ease;
        }

        .btn-read {
            background: #6b46c1;
            color: white;
        }

        .btn-read:hover {
            background: #553c9a;
        }

        .btn-delete {
            background: #dc2626;
            color: white;
        }

        .btn-delete:hover {
            background: #b91c1c;
        }

        .btn-check {
            background: #059669;
            color: white;
            margin-bottom: 1rem;
        }

        .btn-check:hover {
            background: #047857;
        }

        .loading {
            text-align: center;
            padding: 2rem;
            color: #94a3b8;
        }

        .no-messages {
            text-align: center;
            padding: 3rem;
            color: #94a3b8;
        }

        @media (max-width: 768px) {
            .container {
                padding: 1rem;
            }

            .message-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 1rem;
            }

            .message-actions {
                flex-wrap: wrap;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>BMXII Admin Dashboard</h1>
            <p>Contact Messages Management</p>
        </div>

        <div class="db-status" id="dbStatus">
            <button class="btn btn-check" onclick="checkDatabase()">Check Database Health</button>
            <div id="dbStatusContent">Click to check database status...</div>
        </div>

        <div class="stats">
            <div class="stat-card">
                <div class="stat-number" id="totalMessages">-</div>
                <div>Total Messages</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="unreadMessages">-</div>
                <div>Unread Messages</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="todayMessages">-</div>
                <div>Today's Messages</div>
            </div>
        </div>

        <div class="messages-container">
            <h2 style="margin-bottom: 1.5rem;">Recent Messages</h2>
            <div id="messagesContainer">
                <div class="loading">Loading messages...</div>
            </div>
        </div>
    </div>

    <script>
        let messages = [];

        async function checkDatabase() {
            try {
                const response = await fetch('/api/db-check');
                const data = await response.json();
                const statusDiv = document.getElementById('dbStatus');
                const contentDiv = document.getElementById('dbStatusContent');

                if (data.status === 'success') {
                    statusDiv.className = 'db-status healthy';
                    contentDiv.innerHTML = `
                        <strong>✅ Database Healthy</strong><br>
                        Tables: ${data.tables.join(', ')}<br>
                        Records: ${data.record_count}<br>
                        Path: ${data.database_path}
                    `;
                } else {
                    statusDiv.className = 'db-status error';
                    contentDiv.innerHTML = `
                        <strong>❌ Database Error</strong><br>
                        ${data.message}
                    `;
                }
            } catch (error) {
                const statusDiv = document.getElementById('dbStatus');
                const contentDiv = document.getElementById('dbStatusContent');
                statusDiv.className = 'db-status error';
                contentDiv.innerHTML = `<strong>❌ Connection Error</strong><br>${error.message}`;
            }
        }

        async function loadMessages() {
            try {
                const response = await fetch('/api/messages?per_page=50');
                const data = await response.json();
                messages = data.messages;

                updateStats();
                renderMessages();
            } catch (error) {
                console.error('Error loading messages:', error);
                document.getElementById('messagesContainer').innerHTML =
                    '<div class="no-messages">Error loading messages</div>';
            }
        }

        function updateStats() {
            const total = messages.length;
            const unread = messages.filter(msg => !msg.is_read).length;
            const today = messages.filter(msg => {
                const msgDate = new Date(msg.timestamp).toDateString();
                const todayDate = new Date().toDateString();
                return msgDate === todayDate;
            }).length;

            document.getElementById('totalMessages').textContent = total;
            document.getElementById('unreadMessages').textContent = unread;
            document.getElementById('todayMessages').textContent = today;
        }

        function renderMessages() {
            const container = document.getElementById('messagesContainer');

            if (messages.length === 0) {
                container.innerHTML = '<div class="no-messages">No messages found</div>';
                return;
            }

            container.innerHTML = messages.map(msg => `
                <div class="message-card ${msg.is_read ? '' : 'unread'}" id="message-${msg.id}">
                    <div class="message-header">
                        <div class="message-info">
                            <h3>${msg.name}</h3>
                            <p>${msg.email} ${msg.phone ? '• ' + msg.phone : ''}</p>
                            <p>${new Date(msg.timestamp).toLocaleString()}</p>
                        </div>
                        <div class="message-badges">
                            ${msg.is_read ? '' : '<span class="badge unread">Unread</span>'}
                            ${msg.service ? `<span class="badge service">${msg.service}</span>` : ''}
                        </div>
                    </div>
                    <div class="message-content">
                        ${msg.message}
                    </div>
                    <div class="message-actions">
                        <button class="btn btn-read" onclick="toggleRead(${msg.id}, ${msg.is_read})">
                            ${msg.is_read ? 'Mark Unread' : 'Mark Read'}
                        </button>
                        <button class="btn btn-delete" onclick="deleteMessage(${msg.id})">
                            Delete
                        </button>
                    </div>
                </div>
            `).join('');
        }

        async function toggleRead(messageId, isRead) {
            try {
                await fetch(`/api/messages/${messageId}/read`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ is_read: !isRead })
                });

                // Update local data
                const msgIndex = messages.findIndex(msg => msg.id === messageId);
                if (msgIndex !== -1) {
                    messages[msgIndex].is_read = !isRead;
                }

                updateStats();
                renderMessages();
            } catch (error) {
                console.error('Error updating message:', error);
            }
        }

        async function deleteMessage(messageId) {
            if (!confirm('Are you sure you want to delete this message?')) {
                return;
            }

            try {
                await fetch(`/api/messages/${messageId}`, {
                    method: 'DELETE'
                });

                // Remove from local data
                messages = messages.filter(msg => msg.id !== messageId);

                updateStats();
                renderMessages();
            } catch (error) {
                console.error('Error deleting message:', error);
            }
        }

        // Load messages on page load
        loadMessages();

        // Auto-check database on load
        checkDatabase();

        // Refresh every 30 seconds
        setInterval(loadMessages, 30000);
    </script>
</body>
</html>
    """
    return admin_html

@app.route('/api/stats', methods=['GET'])
def get_stats():
    """Get dashboard statistics"""
    try:
        total_messages = ContactMessage.query.count()
        unread_messages = ContactMessage.query.filter_by(is_read=False).count()
        today_messages = ContactMessage.query.filter(
            ContactMessage.timestamp >= datetime.now().date()
        ).count()

        return jsonify({
            'total_messages': total_messages,
            'unread_messages': unread_messages,
            'today_messages': today_messages
        })

    except Exception as e:
        logger.error(f"Error fetching stats: {str(e)}")
        return jsonify({'error': 'Failed to fetch statistics'}), 500

# Error handlers
@app.errorhandler(404)
def not_found(error):
    return jsonify({'error': 'Endpoint not found'}), 404

@app.errorhandler(500)
def internal_error(error):
    return jsonify({'error': 'Internal server error'}), 500

if __name__ == '__main__':
    # Initialize database with proper error handling
    init_database()

    # Run the application
    app.run(debug=True, host='0.0.0.0', port=5000)